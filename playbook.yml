---
- hosts: all
  become: true
  tasks:
  - name: Ensure apt cache is up to date
    apt:
      update_cache: yes

  - name: Install Docker
    apt:
      name: docker.io
      state: present

  - name: Install Python Pip
    apt:
      name: python3-pip
      state: present

  - name: Install Docker SDK for Python
    pip:
      name: docker

  - name: Install Kubernetes packages
    shell: |
      curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -
      apt-add-repository "deb http://apt.kubernetes.io/ kubernetes-xenial main"
      apt-get update -q
      apt-get install -qy kubeadm kubelet kubectl
  - name: Initialize Kubernetes master
    shell: kubeadm init --pod-network-cidr=10.244.0.0/16
    when: inventory_hostname == 'master'
  - name: Copy kubeconfig to vagrant user
    command: cp /etc/kubernetes/admin.conf /home/vagrant/.kube/config
    when: inventory_hostname == 'master'
  - name: Install Flannel network plugin
    shell: kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
    when: inventory_hostname == 'master'
  - name: Join worker nodes to the cluster
    shell: "{{ hostvars['master'].kubeadm_join_command }}"
    when: inventory_hostname != 'master'
  - name: Get join command
    shell: kubeadm token create --print-join-command
    register: kubeadm_join_command
    when: inventory_hostname == 'master'
